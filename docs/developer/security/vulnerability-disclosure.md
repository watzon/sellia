# Vulnerability Disclosure

This document outlines the security vulnerability disclosure process for Sellia.

## Table of Contents

- [Security Policy](#security-policy)
- [Supported Versions](#supported-versions)
- [Reporting a Vulnerability](#reporting-a-vulnerability)
- [What to Include](#what-to-include)
- [What Happens Next](#what-happens-next)
- [Security Best Practices](#security-best-practices)
- [Security Features](#security-features)
- [Known Limitations](#known-limitations)

## Security Policy

We take security vulnerabilities seriously and appreciate your efforts to responsibly disclose them.

### Reporting Security Issues

**DO NOT report security vulnerabilities through public GitHub issues.**

Public disclosure of security vulnerabilities before they are fixed puts all users at risk. Instead, please report vulnerabilities privately via email.

## Supported Versions

Security updates are provided for the following versions:

| Version | Status          | Security Support |
| ------- | --------------- | ---------------- |
| 0.4.x   | Current Release | :white_check_mark: Yes |
| 0.3.x   | Previous        | :white_check_mark: Yes |
| 0.2.x   | End of Life     | :x: No |

**Note:** Sellia is currently in pre-1.0 development. API and features may change. Once 1.0 is released, we'll follow semantic versioning and provide clear support timelines.

## Reporting a Vulnerability

### How to Report

**Email your report to:**

**chris@watzon.tech**

Please include **[SECURITY]** in the subject line to ensure your report gets immediate attention.

### PGP Key (Optional)

For sensitive communications, you can encrypt your report using PGP:

```
-----BEGIN PGP PUBLIC KEY BLOCK-----
[PGP key would be here - add if you maintain one]
-----END PGP PUBLIC KEY BLOCK-----
```

### What to Expect

1. **Acknowledgment** (within 48 hours)
   - We'll confirm receipt of your report
   - May ask clarifying questions

2. **Initial Assessment** (within 1 week)
   - We'll verify and classify the vulnerability
   - Determine severity level
   - Estimate remediation time

3. **Resolution Timeline**
   - **Critical:** 7 days
   - **High:** 30 days
   - **Medium:** 60 days
   - **Low:** 90 days

We'll keep you informed throughout the process and may ask for additional information or verification.

## What to Include

Your vulnerability report should include:

### 1. Vulnerability Type

Classify the vulnerability:

**Common Types:**
- **Buffer Overflow** - Memory corruption issues
- **Injection** - SQL, command, code injection
- **XSS** (Cross-Site Scripting) - Reflected or stored
- **CSRF** (Cross-Site Request Forgery)
- **Authentication/Authorization** - Bypass, weak auth
- **Information Disclosure** - Sensitive data exposure
- **Denial of Service** - Resource exhaustion
- **Cryptography** - Weak algorithms, implementation flaws
- **Insecure Deserialization** - Object injection
- **SSRF** (Server-Side Request Forgery)
- **Path Traversal** - Directory traversal

### 2. Affected Versions

Which versions are affected:

```markdown
**Affected Versions:**
- All versions <= 0.4.0
- Confirmed on: 0.4.0
- Fixed in: 0.4.1 (upcoming)

**Environment:**
- OS: [e.g., Linux, macOS]
- Crystal: [e.g., 1.18.0]
- Deployed: [Docker, binary, source]
```

### 3. Impact Assessment

Describe the potential impact:

```markdown
**Impact:**
- Attackers can [what they can do]
- Requires [authentication, user interaction, etc.]
- Affects [all users / specific configurations]

**Severity:** [Critical / High / Medium / Low]

**Business Impact:**
- Data exposure: [What data]
- System compromise: [To what extent]
- Lateral movement: [Can it spread]
```

### 4. Reproduction Steps

Provide step-by-step reproduction:

```markdown
**Reproduction Steps:**

1. Start server with configuration:
   ```bash
   ./bin/sellia-server --port 3000 --domain example.com
   ```

2. Create tunnel:
   ```bash
   ./bin/sellia http 8080 --server http://localhost:3000
   ```

3. Send malicious request:
   ```bash
   curl -X POST http://tunnel.example.com \
     -H "Content-Type: application/json" \
     -d '{"malicious":"payload"}'
   ```

4. Observe: [Describe what happens]

**Expected Behavior:** [What should happen]
**Actual Behavior:** [What actually happens]
```

### 5. Proof of Concept

Include exploit code or detailed steps:

```markdown
**Proof of Concept:**

```bash
# Exploit script
#!/bin/bash
TARGET="http://victim.example.com"
curl -X POST "$TARGET" -d "$(python3 -c 'print("A"*1000)')"
```

**Result:** Server crashes with segfault
```

**Important:** Only include safe, minimal proof-of-concept code. Don't include destructive payloads or data from actual systems.

### 6. Suggested Fix (Optional)

If you have a suggested fix:

```markdown
**Suggested Fix:**

The vulnerability occurs in `src/server/http_ingress.cr:42` where
user input is not validated before processing. Suggested fix:

```crystal
# Before (vulnerable)
headers[key] = value

# After (fixed)
if value.size < MAX_HEADER_SIZE
  headers[key] = value
else
  raise HeaderTooLargeError.new
end
```
```

### 7. Additional Context

Any other relevant information:

```markdown
**Additional Context:**

- This was discovered during [penetration testing / code review / etc.]
- Similar issue: [link to CVE if applicable]
- References: [OWASP, CWE, etc.]
- Affected configurations: [specific setups only]
```

## What Happens Next

### 1. Validation

We'll validate the vulnerability:
- Reproduce the issue
- Confirm impact
- Classify severity
- Check other affected versions

### 2. Remediation

We'll develop a fix:
- Create patch
- Test thoroughly
- Ensure no regressions
- Add tests to prevent recurrence

### 3. Coordinated Disclosure

We follow responsible disclosure:

**Timeline:**
- Fix the vulnerability
- Prepare security advisory
- Coordinate release with maintainers
- Publish disclosure simultaneously with fix

**Credit:**
- We'll credit you in the release notes
- Unless you prefer to remain anonymous
- Specify your preference when reporting

### 4. Public Disclosure

After fix is deployed:

- **Security Advisory:** Published on GitHub
- **Release Notes:** Include vulnerability details
- **CVE Assignment:** We'll request a CVE if applicable
- **Credit:** Thank contributors publicly

## Security Best Practices

### For Self-Hosted Deployments

#### Network Security

**Use HTTPS:**
```bash
# Place Sellia behind a reverse proxy with TLS
# Example nginx config:
server {
    listen 443 ssl;
    server_name tunnels.example.com;

    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

**Firewall Configuration:**
```bash
# Restrict access to server port
sudo ufw allow 443/tcp  # HTTPS only
sudo ufw deny 3000/tcp  # Block direct server access

# Or restrict to specific IPs
sudo ufw allow from 192.168.1.0/24 to any port 3000
```

**Rate Limiting:**
```bash
# Keep rate limiting enabled (default)
./bin/sellia-server --port 3000

# Only disable for development testing
./bin/sellia-server --port 3000 --no-rate-limit  # DON'T use in production
```

#### Authentication

**Use API Keys:**
```bash
# Generate secure random key
MASTER_KEY=$(openssl rand -hex 32)

# Start server with authentication
./bin/sellia-server \
  --port 3000 \
  --require-auth \
  --master-key $MASTER_KEY
```

**Or use environment variables:**
```bash
# .env file (don't commit this!)
SELLIA_REQUIRE_AUTH=true
SELLIA_MASTER_KEY=$(openssl rand -hex 32)
```

**Rotate Keys Regularly:**
```bash
# Generate new key
NEW_KEY=$(openssl rand -hex 32)

# Restart server with new key
./bin/sellia-server --master-key $NEW_KEY

# Update all clients with new key
./bin/sellia http 3000 --api-key $NEW_KEY
```

**Secure Key Storage:**
- Use `.env` files (in `.gitignore`)
- Use secrets management (HashiCorp Vault, AWS Secrets Manager)
- Never commit keys to git
- Use different keys for dev/staging/prod

#### Subdomain Security

**Reserved Subdomains:**
```bash
# The following subdomains are blocked by default:
- api, www, admin, administrator, root, etc.
- You can add custom reserved subdomains in config
```

**Subdomain Validation:**
- Subdomains must follow DNS label rules
- Max length: 63 characters
- Allowed characters: alphanumeric and hyphens
- No consecutive hyphens
- No leading/trailing hyphens

#### Monitoring

**Enable Debug Logging:**
```bash
# For security monitoring
LOG_LEVEL=debug ./bin/sellia-server --port 3000
```

**Monitor for Suspicious Activity:**
- Unusual connection patterns
- Requests from unknown IPs
- High request volumes
- Failed authentication attempts
- Unexpected subdomain access

#### Database Security (SQLite)

**File Permissions:**
```bash
# Restrict database file access
chmod 600 sellia.db
chown app_user:app_group sellia.db
```

**Regular Backups:**
```bash
# Backup SQLite database
cp sellia.db sellia.db.backup.$(date +%Y%m%d)
```

## Security Features

Sellia includes several built-in security features:

### Rate Limiting

**Token Bucket Algorithm:**
- Connections: 10 per second per IP
- Tunnels: 5 per minute per IP
- Requests: 100 per second per tunnel

```crystal
# Configuration
rate_limits:
  connections: 10/sec
  tunnels: 5/min
  requests: 100/sec
```

### Subdomain Validation

**DNS Label Compliance:**
```crystal
# Validation rules
- Max 63 characters
- Alphanumeric + hyphens only
- No consecutive hyphens
- No leading/trailing hyphens
- Reserved name blocklist
```

### Input Validation

**Request Size Limits:**
```crystal
# Maximum sizes
- Request headers: 8KB
- Request body: 10MB (configurable)
- Response headers: 8KB
- Response body: No limit (streaming)
```

**Header Validation:**
```crystal
# Invalid headers rejected
- Headers with newlines
- Headers > 8KB
- Missing required headers
```

### Connection Timeouts

**WebSocket Heartbeat:**
```crystal
# Detects stale connections
ping_interval: 30s
ping_timeout: 10s
max_missed_pings: 3
```

### Graceful Degradation

**Client Disconnect Handling:**
```crystal
# Pending requests cleaned up
on_disconnect:
  - Cancel pending requests
  - Return 502 to clients
  - Cleanup resources
```

## Known Limitations

### Current Security Considerations

#### Basic Auth Over HTTP

```markdown
**Issue:** Basic auth credentials are transmitted in base64

**Risk:** Credentials can be decoded if intercepted

**Mitigation:** Always use HTTPS in production
- Place Sellia behind reverse proxy with TLS
- Use Cloudflare Origin Certificates
- Or use Let's Encrypt

**Status:** Will be addressed in future release
```

#### In-Memory State

```markdown
**Issue:** State is in-memory, lost on restart

**Impact:**
- API keys: Now persisted to SQLite (fixed in 0.2.0)
- Reserved subdomains: Now persisted to SQLite (fixed in 0.2.0)
- Active tunnels: Lost on restart (by design)

**Mitigation:** Use SQLite storage for persistent data

**Status:** Partially addressed
```

#### No Built-in TLS

```markdown
**Issue:** Sellia doesn't include TLS termination

**Risk:** Unencrypted traffic between client and server

**Mitigation:**
- Use reverse proxy (nginx, Caddy, Traefik)
- Enable TLS at proxy level
- Use Cloudflare for TLS

**Status:** By design - flexibility for deployment
```

## Responsible Disclosure Policy

### Our Commitment

We promise to:

1. **Respond promptly** to security reports
2. **Keep you informed** throughout the process
3. **Credit contributors** (unless anonymity requested)
4. **Coordinate disclosure** to protect users
5. **Fix issues** before public disclosure

### We Ask You To

1. **Report responsibly** - Don't disclose publicly before fix
2. **Provide details** - Help us understand and reproduce
3. **Give us time** - Allow reasonable time for fix
4. **Follow good faith** - Don't exploit vulnerabilities

### Disclosure Timeline

**Ideal Timeline:**
- Day 0: Vulnerability reported
- Day 2: Acknowledgment and validation
- Day 7: Fix developed and tested
- Day 14: Coordinated disclosure and release

**Extended Timeline:**
For complex vulnerabilities, timeline may be extended:
- We'll inform you of delays
- You'll have opportunity to comment on advisory
- Disclosure coordinated with all parties

## Security Announcements

Stay informed about security updates:

- **GitHub Releases:** Watch [watzon/sellia](https://github.com/watzon/sellia)
- **Security Advisories:** Check [GitHub Security Advisories](https://github.com/watzon/sellia/security/advisories)
- **CHANGELOG:** Review changelog for security fixes

## Security Contacts

### For Vulnerability Reports

**Primary:** chris@watzon.tech
**Subject:** [SECURITY] Vulnerability Report

### For Security Questions

**GitHub Issues:** Use `security` label
**Discussions:** Ask in GitHub Discussions

### For Emergencies

If you believe a vulnerability is being actively exploited:

**Subject:** [URGENT] Active Exploitation
- Provide immediate details
- Include evidence of exploitation
- We'll respond as soon as possible

## Resources

### Security References

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [CWE Top 25](https://cwe.mitre.org/top25/)
- [Crystal Security Guide](https://crystal-lang.org/reference/guides/security.html)

### Related Tools

- [OpenSSL](https://www.openssl.org/) - TLS/SSL
- [Let's Encrypt](https://letsencrypt.org/) - Free certificates
- [Cloudflare SSL](https://cloudflare.com) - Origin certificates

## Acknowledgments

We thank all security researchers who have responsibly disclosed vulnerabilities to help make Sellia more secure.

**Recent Contributors:**
- (List will be updated as vulnerabilities are reported)

## Next Steps

- [Development Setup](../development/prerequisites.md) - Start contributing
- [Testing](../development/testing.md) - Test security features
- [Deployment](../../user/deployment/index.md) - Secure deployment guide
