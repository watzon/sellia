# TLS Certificates

Sellia requires TLS certificates to serve HTTPS tunnels. This guide covers certificate setup for production deployments.

## Why TLS Certificates?

HTTPS tunnels require valid TLS certificates to:
- Encrypt traffic between clients and the tunnel server
- Enable secure WebSocket connections
- Provide trust to browsers and API clients
- Meet modern security standards

## Certificate Sources

### 1. Cloudflare Origin Certificate (Recommended)

Free, long-lasting certificates from Cloudflare.

**Pros:**
- Free for Cloudflare customers
- 15-year validity
- Wildcard certificates supported
- Easy generation

**Cons:**
- Requires Cloudflare account
- Only works with Cloudflare proxy

### 2. Let's Encrypt

Free, automated certificates via ACME.

**Pros:**
- Free
- Automated renewal
- Publicly trusted
- Works with any setup

**Cons:**
- 90-day validity (requires automation)
- Rate limited
- Requires domain validation

### 3. Self-Signed Certificates

Generated by you for testing.

**Pros:**
- Quick to generate
- No external dependencies
- Good for local testing

**Cons:**
- Not publicly trusted
- Browser warnings
- Not suitable for production

### 4. Commercial CA

Purchased certificates from authorities.

**Pros:**
- Publicly trusted
- Various validation levels
- Insurance options

**Cons:**
- Cost (annual fees)
- Shorter validity (1-2 years)
- Manual renewal process

## Cloudflare Origin Certificate

### Step 1: Add Domain to Cloudflare

1. Sign up for [Cloudflare](https://cloudflare.com) (free tier works)
2. Add your domain: ****Sites** → **Add a Site**
3. Follow instructions to update nameservers
4. Wait for DNS propagation (usually <24 hours)

### Step 2: Generate Origin Certificate

1. Go to **SSL/TLS** → **Origin Server** → **Create Certificate**
2. Select options:
   - **Hostnames**: `*.yourdomain.com` and `yourdomain.com`
   - **Validity**: 15 years
   - **Key format**: PEM (default)
3. Click **Create**

### Step 3: Download Certificates

1. Click **Download Certificate** to get `origin.pem`
2. Click **Download Private Key** to get `origin.key`

### Step 4: Place Certificates

Create `certs/` directory and place certificates:

```bash
mkdir -p certs
mv ~/Downloads/origin.pem certs/cert.pem
mv ~/Downloads/origin.key certs/key.pem
```

Structure:
```
certs/
├── cert.pem  # Origin certificate
└── key.pem   # Private key
```

### Step 5: Set Permissions

Secure the private key:

```bash
chmod 644 certs/cert.pem
chmod 600 certs/key.pem
```

### Step 6: Start Server

```bash
docker compose -f docker-compose.prod.yml up -d
```

The docker-compose.prod.yml file automatically sets `SELLIA_USE_HTTPS=true` for the Sellia server.

## Let's Encrypt Certificates

### Using Certbot

#### Step 1: Install Certbot

```bash
# Ubuntu/Debian
sudo apt-get install certbot

# macOS
brew install certbot

# Docker
docker run -it --rm \
  -v /etc/letsencrypt:/etc/letsencrypt \
  certbot/certbot certonly --manual
```

#### Step 2: Generate Certificate

**HTTP-01 Challenge (requires port 80):**

```bash
sudo certbot certonly \
  --standalone \
  -d yourdomain.com \
  -d *.yourdomain.com
```

**DNS-01 Challenge (wildcard):**

```bash
sudo certbot certonly \
  --manual \
  --preferred-challenges dns \
  -d yourdomain.com \
  -d *.yourdomain.com
```

Follow prompts for DNS validation.

#### Step 3: Copy Certificates

```bash
mkdir -p certs
sudo cp /etc/letsencrypt/live/yourdomain.com/fullchain.pem certs/cert.pem
sudo cp /etc/letsencrypt/live/yourdomain.com/privkey.pem certs/key.pem
sudo chown $USER:$USER certs/*.pem
chmod 644 certs/cert.pem
chmod 600 certs/key.pem
```

#### Step 4: Set Up Auto-Renewal

Certbot automatically sets up renewal:

```bash
# Test renewal
sudo certbot renew --dry-run

# Renewal runs automatically via cron/systemd
```

For Docker, mount certificates:

```yaml
volumes:
  - /etc/letsencrypt:/etc/letsencrypt:ro
```

### Using Caddy

Caddy can automatically obtain and renew certificates:

#### Step 1: Create Caddyfile

```caddyfile
# Caddyfile
yourdomain.com, *.yourdomain.com {
    reverse_proxy localhost:3000
}
```

#### Step 2: Run Caddy

```bash
docker run -d \
  --name caddy \
  -p 80:80 \
  -p 443:443 \
  -v $(pwd)/Caddyfile:/etc/caddy/Caddyfile \
  caddy:latest
```

Caddy automatically handles HTTPS.

## Self-Signed Certificates (Testing)

### Generate with OpenSSL

```bash
mkdir -p certs

# Generate private key
openssl genrsa -out certs/key.pem 2048

# Generate certificate
openssl req -new -x509 \
  -key certs/key.pem \
  -out certs/cert.pem \
  -days 365 \
  -subj "/CN=*.yourdomain.com"
```

### Generate with One Command

```bash
openssl req -x509 -newkey rsa:2048 \
  -keyout certs/key.pem \
  -out certs/cert.pem \
  -days 365 \
  -nodes \
  -subj "/CN=*.yourdomain.com"
```

### Use for Testing

```bash
# .env
SELLIA_DOMAIN=localhost
SELLIA_USE_HTTPS=true
```

**Warning:** Browsers will show security warnings. Only for local testing.

## Docker Deployment with Certificates

### Directory Structure

```
project/
├── docker-compose.prod.yml
├── .env
└── certs/
    ├── cert.pem
    └── key.pem
```

### Docker Compose Configuration

```yaml
version: '3.8'

services:
  sellia-server:
    image: ghcr.io/watzon/sellia:latest
    environment:
      - SELLIA_DOMAIN=${SELLIA_DOMAIN}
      - SELLIA_MASTER_KEY=${SELLIA_MASTER_KEY}
      - SELLIA_REQUIRE_AUTH=true
    env_file: .env
    restart: unless-stopped
    networks:
      - sellia-internal

  caddy:
    image: caddy:2-alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./deploy/Caddyfile:/etc/caddy/Caddyfile:ro
      - ./certs:/certs:ro
      - caddy_data:/data
      - caddy_config:/config
    environment:
      - SELLIA_DOMAIN=${SELLIA_DOMAIN}
    networks:
      - sellia-internal
    depends_on:
      - sellia-server
    restart: unless-stopped

networks:
  sellia-internal:
    driver: bridge

volumes:
  caddy_data:
  caddy_config:
```

### Environment File

```bash
# .env
SELLIA_DOMAIN=yourdomain.com
SELLIA_MASTER_KEY=$(openssl rand -hex 32)
SELLIA_REQUIRE_AUTH=true
```

## Certificate Validation

### Check Certificate

```bash
# View certificate details
openssl x509 -in certs/cert.pem -text -noout

# Check validity
openssl x509 -in certs/cert.pem -noout -dates

# Verify certificate matches key
openssl x509 -noout -modulus -in certs/cert.pem | openssl md5
openssl rsa -noout -modulus -in certs/key.pem | openssl md5
# Both MD5 hashes should match
```

### Test HTTPS Connection

```bash
# Test with curl
curl -I https://yourdomain.com

# Test with OpenSSL
openssl s_client -connect yourdomain.com:443 -servername yourdomain.com

# Check certificate chain
openssl s_client -connect yourdomain.com:443 -showcerts
```

## Reverse Proxy Setup

### Nginx with TLS

```nginx
server {
    listen 80;
    server_name yourdomain.com *.yourdomain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name yourdomain.com *.yourdomain.com;

    ssl_certificate /path/to/certs/cert.pem;
    ssl_certificate_key /path/to/certs/key.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### Caddy with TLS

Caddy handles TLS automatically:

```caddyfile
yourdomain.com, *.yourdomain.com {
    reverse_proxy localhost:3000
}
```

## Certificate Renewal

### Let's Encrypt Renewal

Automatic via cron/systemd:

```bash
# Test renewal
sudo certbot renew --dry-run

# View renewal timer
sudo systemctl status certbot.timer
```

### Cloudflare Renewal

Cloudflare Origin certificates are valid for 15 years - no renewal needed.

### Manual Renewal

For other certificates:

```bash
# Generate new certificates
# Copy to certs directory
# Restart Sellia
docker compose restart
```

## Troubleshooting

### Certificate Not Found

**Error:** `Failed to load certificate`

**Solution:**
```bash
# Verify files exist
ls -la certs/

# Check permissions
chmod 644 certs/cert.pem
chmod 600 certs/key.pem

# Verify file content
cat certs/cert.pem
cat certs/key.pem
```

### Domain Mismatch

**Error:** `Certificate does not match domain`

**Solution:**
```bash
# Check certificate domain
openssl x509 -in certs/cert.pem -noout -subject

# Should show: CN = *.yourdomain.com
```

### Browser Warnings

**Self-signed certificates:**
- Expected for local testing
- Add exception in browser
- Not for production use

**Cloudflare certificates:**
- Ensure Cloudflare proxy is enabled (orange cloud)
- Check DNS propagation

### Port Already in Use

```bash
# Check what's using port 443
lsof -i :443

# Stop conflicting service
sudo systemctl stop nginx
```

## Security Best Practices

### 1. File Permissions

```bash
# Certificate: readable by all
chmod 644 certs/cert.pem

# Private key: readable only by owner
chmod 600 certs/key.pem
```

### 2. Don't Commit Certificates

Add to `.gitignore`:

```bash
# .gitignore
certs/
*.pem
*.key
```

### 3. Use Strong Keys

```bash
# Generate 2048-bit or 4096-bit keys
openssl genrsa -out certs/key.pem 4096
```

### 4. Monitor Expiration

```bash
# Check expiration
openssl x509 -in certs/cert.pem -noout -enddate

# Set up expiration alerts
# (monitoring system integration)
```

### 5. Separate Environments

Use different certificates per environment:

```bash
certs/dev/cert.pem
certs/dev/key.pem

certs/staging/cert.pem
certs/staging/key.pem

certs/prod/cert.pem
certs/prod/key.pem
```

## Certificate Comparison

| Method | Cost | Validity | Automation | Trust | Best For |
|--------|------|----------|------------|-------|----------|
| Cloudflare Origin | Free | 15 years | No | Cloudflare only | Production with Cloudflare |
| Let's Encrypt | Free | 90 days | Yes | Public | Production (any setup) |
| Self-Signed | Free | Custom | No | None | Local testing only |
| Commercial CA | $$ | 1-2 years | Partial | Public | Enterprise requirements |

## Next Steps

- [Docker Deployment](./docker.md) - Full Docker setup
- [Self-Hosting](../getting-started/self-hosting-quickstart.md) - Server configuration
- [Configuration](../configuration/config-file.md) - Config files

## Quick Reference

### Generate Self-Signed Cert

```bash
openssl req -x509 -newkey rsa:2048 \
  -keyout certs/key.pem \
  -out certs/cert.pem \
  -days 365 \
  -nodes \
  -subj "/CN=*.yourdomain.com"
```

### Check Certificate

```bash
openssl x509 -in certs/cert.pem -text -noout
```

### Verify Key Match

```bash
openssl x509 -noout -modulus -in certs/cert.pem | openssl md5
openssl rsa -noout -modulus -in certs/key.pem | openssl md5
```

### Test HTTPS

```bash
curl -I https://yourdomain.com
openssl s_client -connect yourdomain.com:443
```

### Permissions

```bash
chmod 644 certs/cert.pem
chmod 600 certs/key.pem
```
