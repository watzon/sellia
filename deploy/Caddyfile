# Sellia Caddyfile
#
# Uses wildcard certificates via Cloudflare DNS challenge.
#
# Required: CLOUDFLARE_API_TOKEN environment variable
# Create token at: https://dash.cloudflare.com/profile/api-tokens
# Token needs: Zone:DNS:Edit permission for your domain

{
	acme_dns cloudflare {env.CLOUDFLARE_API_TOKEN}

	# Disable HTTP/3 - it can cause request cancellation issues with tunneled traffic
	servers {
		protocols h1 h2
	}
}

# Wildcard for all tunnel subdomains
*.{$SELLIA_DOMAIN} {
	reverse_proxy sellia-server:3000 {
		header_up Host {host}
		header_up X-Real-IP {remote_host}
		header_up Connection {>Connection}
		header_up Upgrade {>Upgrade}
		flush_interval -1
	}

	log {
		output file /var/log/caddy/tunnels.log
		format json
	}
}

# Base domain for WebSocket connections and health checks
{$SELLIA_DOMAIN} {
	reverse_proxy sellia-server:3000 {
		header_up Host {host}
		header_up X-Real-IP {remote_host}
		header_up Connection {>Connection}
		header_up Upgrade {>Upgrade}
		flush_interval -1
	}

	log {
		output file /var/log/caddy/sellia.log
		format json
	}
}

# Health check endpoint for load balancers
:8080 {
	respond /health 200
}
