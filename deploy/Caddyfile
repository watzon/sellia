# Sellia Caddyfile
#
# TLS Certificates:
#   Place your certificate and key in /certs/ directory:
#   - /certs/cert.pem (certificate)
#   - /certs/key.pem (private key)
#
#   For Cloudflare Origin Certificates:
#   1. Go to Cloudflare Dashboard > SSL/TLS > Origin Server > Create Certificate
#   2. Download the certificate and key
#   3. Place them in the certs/ directory
#
#   The docker-compose.yml should mount this directory:
#   volumes:
#     - ./certs:/certs:ro

{
	# Disable HTTP/3 - it can cause request cancellation issues with tunneled traffic
	servers {
		protocols h1 h2
	}
}

# HTTP to HTTPS redirect
:80 {
	respond /health 200

	# Redir all other HTTP requests to HTTPS
	@host {
		host {args.0}
		not {args.0} :8080
	}
	redir @host https://{host}{uri}
}

# Wildcard for all tunnel subdomains
*.{$SELLIA_DOMAIN} {
	reverse_proxy sellia-server:3000 {
		header_up Host {host}
		header_up X-Real-IP {remote_host}
		flush_interval -1
	}

	tls /certs/cert.pem /certs/key.pem

	log {
		output file /var/log/caddy/tunnels.log
		format json
	}
}

# Base domain for WebSocket connections and health checks
{$SELLIA_DOMAIN} {
	reverse_proxy sellia-server:3000 {
		header_up Host {host}
		header_up X-Real-IP {remote_host}
		flush_interval -1
	}

	tls /certs/cert.pem /certs/key.pem

	log {
		output file /var/log/caddy/sellia.log
		format json
	}
}
